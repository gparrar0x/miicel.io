# Lessons Learned: Tri-Agent Coordination (SKY-6)

**Date:** 2025-01-15
**Session:** Admin Dashboard Layout Implementation
**Issue:** SKY-6 - Build Admin Dashboard Layout
**Agents:** Mentat (coordinator) + Kokoro (backend) + Pixel (frontend) + Sentinela (QA)

---

## üéØ Context

Primera implementaci√≥n coordinada de 3 agentes especializados en paralelo para un mismo issue. Objetivo: crear admin layout con sidebar navigation + tests E2E completos.

---

## ‚úÖ What Went Well

### 1. **Tri-Agent Coordination Pattern**

**Pattern usado:**
```
Mentat (coordinator)
  ‚îú‚îÄ> Kokoro (backend) - paralelo
  ‚îú‚îÄ> Pixel (frontend) - paralelo
  ‚îî‚îÄ> Sentinela (QA) - paralelo
```

**Por qu√© funcion√≥:**
- Clear separation of concerns (backend/frontend/QA)
- Each agent had autonomous task list (KOKORO_TASKS.md, PIXEL_TASKS.md, SENTINELA_TASKS.md)
- Contract-based communication (`data-testid` entre Pixel‚ÜîSentinela)
- Mentat solo coordin√≥ + fij√≥ errores cross-agent

**Resultado:** 3 agentes shipped en ~2h de wall time (vs ~12-14h secuencial).

---

### 2. **Contract-Driven Development**

**Contract definido por Mentat:**
```typescript
// Pixel DEBE implementar:
data-testid="admin-sidebar"
data-testid="nav-products"
data-testid="nav-orders"
...

// Sentinela DEBE usar:
page.getByTestId('admin-sidebar')
```

**Benefit:** Zero coupling, agents trabajaron independiente. Sentinela no esper√≥ Pixel finish para escribir tests.

---

### 3. **SENTINELA_TASKS.md as Executable Spec**

En lugar de brief vague, creamos doc con:
- Step-by-step implementation plan
- Code snippets completos (copy-paste ready)
- Effort estimates por step
- Contract de `data-testid` expl√≠cito

**Impact:** Sentinela ejecut√≥ sin ambig√ºedad, output predecible.

---

### 4. **Idempotent Test Data Strategy**

Pattern get-or-create en seed:
```typescript
const existing = await find(email)
if (existing) {
  use(existing)
} else {
  create(new)
}
```

**Why:** Tests corren N veces sin fallar (CI-friendly).

---

### 5. **Next.js 15+ Migration Patterns**

Fix aplicado:
```typescript
// ‚ùå Before (sync params)
params.tenant

// ‚úÖ After (async params)
const resolvedParams = await params
const tenantSlug = resolvedParams.tenant
```

**Lesson:** Next.js 16+ requiere `await params` en Server Components. Client components necesitan state + useEffect.

---

## üî¥ What Didn't Work

### 1. **Supabase Admin API Permissions**

**Issue:** `supabase.auth.admin.listUsers()` no retorna all users con service role key.

**Root cause:** Permissions incompletas o API pagination issue.

**Impact:** Test seed falla con "user already registered" pero no puede retrieve existing user.

**Fix aplicado:** Pagination retry loop (l√≠neas 73-91 seed-test-data.ts).

**Better solution (pending SKY-36):**
- Option A: Fix service role permissions en Supabase dashboard
- Option B: Refactor seed a usar `signInWithPassword()` instead of admin API
- Option C: Manual user creation pre-test

**Lesson:** Admin APIs son fr√°giles. Prefer user-facing APIs (signup/login) para test fixtures cuando sea posible.

---

### 2. **Agent Output Trust Issues**

**Problem:** Sentinela report√≥ "fix aplicado" pero c√≥digo no cambi√≥.

**Root cause:** Agent cache o tool malfunction. Output dec√≠a "modified successfully" pero file unchanged.

**Workaround:** Mentat valid√≥ con `Read` tool + aplic√≥ fix manually.

**Lesson:** **ALWAYS verify agent output con file reads**, especialmente si error persiste despu√©s de "fix".

---

### 3. **Duplicate Code After Edit**

**Bug encontrado:** `seed-test-data.ts:187-188` tiene l√≠neas duplicadas:
```typescript
nonOwner = newNonOwner.user
console.log(`‚úì Non-owner user created: ${nonOwner.id}`)
```

Aparece 2 veces (dentro del `else if` Y despu√©s del bloque).

**Root cause:** Edit tool agreg√≥ c√≥digo pero no removi√≥ old code.

**Impact:** Variable reassignment innecesario (no break, pero code smell).

**Lesson:** Check for duplicate lines despu√©s de `Edit` tool, especialmente con blocks grandes.

---

### 4. **Test Execution Without Validation**

**Issue:** Tests no corrieron successfully end-to-end debido a seed blocker.

**Oversight:** Shipped con assumption de que seed works, pero no validado hasta commit.

**Better approach:**
1. Run test suite BEFORE declaring "done"
2. Si hay blockers conocidos, documentar en commit message
3. Crear follow-up issue BEFORE commit (‚úÖ hicimos esto con SKY-36)

**Lesson:** "Definition of Done" para QA debe incluir green test run, no solo "tests escritos".

---

## üîß Process Improvements

### 1. **Pre-Flight Checklist para Multi-Agent**

Antes de lanzar agents en paralelo:

```markdown
- [ ] Contracts definidos (interfaces, data-testid, API schemas)
- [ ] Task files creados (AGENT_TASKS.md)
- [ ] Dependencies claras (Agent A blocks Agent B?)
- [ ] Success criteria expl√≠citos por agent
- [ ] Integration point identificado (d√≥nde se juntan outputs?)
```

---

### 2. **Agent Handoff Protocol**

Cuando Agent A completa:

```markdown
## Agent A Output
- [ ] Files created/modified (list paths)
- [ ] Contracts fulfilled (checkboxes)
- [ ] Tests passing (if applicable)
- [ ] Blockers for Agent B (if any)
```

Mentat verifica checklist antes de siguiente agent.

---

### 3. **Test-First for Infra**

Para test infrastructure (seed, fixtures, helpers):

1. Write minimal test first (e.g., "seed creates owner user")
2. Run test (expect fail)
3. Implement seed
4. Run test (expect pass)

**Benefit:** Catches permission issues EARLY.

---

## üìä Metrics

| Metric | Value | Notes |
|--------|-------|-------|
| **Wall time** | ~2h | Parallel execution |
| **Sequential estimate** | ~12-14h | If done serially |
| **Speedup** | 6-7x | Tri-agent parallelism |
| **Files created** | 13 | UI + tests + fixtures |
| **LOC added** | ~1500 | Across all agents |
| **Tests written** | 10 | E2E coverage |
| **Tests passing** | 0/10* | *Blocked by seed issue |
| **Issues created** | 1 | SKY-36 (seed fix) |
| **Commits** | 1 | Single atomic commit |

---

## üéì Key Takeaways

### For Mentat (Coordinator)

1. **Define contracts upfront** - Clear interfaces between agents
2. **Create task files** - Executable specs (AGENT_TASKS.md)
3. **Verify agent output** - Don't trust "success" messages, read files
4. **Check for duplicates** - Edit tool puede duplicar c√≥digo
5. **Run tests before shipping** - Green CI = Definition of Done

### For Kokoro (Backend)

1. **Middleware first** - Auth guards block frontend work
2. **Service role != admin role** - Permissions can be limited
3. **Export types** - Frontend needs them for API calls

### For Pixel (Frontend)

1. **data-testid everywhere** - Contract with Sentinela
2. **Await params** - Next.js 15+ async pattern
3. **Responsive from day 1** - Mobile breakpoints early

### For Sentinela (QA)

1. **Page Object Model** - Encapsulate locators
2. **Idempotent fixtures** - Get-or-create pattern
3. **Prefer user APIs** - Avoid admin APIs for test data
4. **Document seed prerequisites** - Manual steps if needed

---

## üîÆ Future Work

### Immediate (SKY-36)

- [ ] Fix test seed permissions
- [ ] Validate 10/10 tests passing
- [ ] Add CI workflow (.github/workflows/e2e-tests.yml)

### Next Features

- [ ] Products page (CRUD UI)
- [ ] Orders page (list + detail)
- [ ] Settings page (config forms)

### Process

- [ ] Automate tri-agent pattern (script/tool?)
- [ ] Template AGENT_TASKS.md files
- [ ] Pre-commit hook: run relevant tests

---

## üìö References

**Docs created:**
- `docs/projects/sw_commerce_saas/SENTINELA_TASKS.md`

**Issues:**
- SKY-6: Admin Dashboard Layout (‚úÖ DONE)
- SKY-36: Fix Test Data Seed (‚è≥ PENDING)

**Commits:**
- `5ee1381`: feat(admin): Admin Dashboard Layout + E2E Tests (SKY-6)

**Linear:**
- https://linear.app/publica/issue/SKY-6
- https://linear.app/publica/issue/SKY-36

---

**TL;DR:** Tri-agent pattern works brilliantly when contracts are clear. Main lesson: verify agent output + run tests before declaring victory. Seed permissions = sneaky blocker.
