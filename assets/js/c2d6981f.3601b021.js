"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[236],{4505:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"incidents/mii-6-dashboard-redirect-loop","title":"MII-6: Dashboard Redirect Loop (Dec 2025)","description":"Summary","source":"@site/docs/incidents/mii-6-dashboard-redirect-loop.md","sourceDirName":"incidents","slug":"/incidents/mii-6-dashboard-redirect-loop","permalink":"/miicel.io/incidents/mii-6-dashboard-redirect-loop","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"MII-6 Dashboard Redirect Loop","sidebar_position":1}}');var d=i(4848),o=i(8453);const s={sidebar_label:"MII-6 Dashboard Redirect Loop",sidebar_position:1},t="MII-6: Dashboard Redirect Loop (Dec 2025)",c={},l=[{value:"Summary",id:"summary",level:2},{value:"Impact",id:"impact",level:2},{value:"Root Cause",id:"root-cause",level:2},{value:"Fix",id:"fix",level:2},{value:"Verification",id:"verification",level:2},{value:"Lessons Learned",id:"lessons-learned",level:2},{value:"Timeline (UTC)",id:"timeline-utc",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"mii-6-dashboard-redirect-loop-dec-2025",children:"MII-6: Dashboard Redirect Loop (Dec 2025)"})}),"\n",(0,d.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,d.jsxs)(n.p,{children:["Authenticated users were stuck in an infinite redirect between ",(0,d.jsx)(n.code,{children:"/en/login"})," and ",(0,d.jsx)(n.code,{children:"/en/3/dashboard"}),". The middleware (proxy) could not resolve the tenant or the user role, so every dashboard request was bounced back to login, causing ERR_TOO_MANY_REDIRECTS."]}),"\n",(0,d.jsx)(n.h2,{id:"impact",children:"Impact"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"Tenant admins could not access the admin dashboard after login."}),"\n",(0,d.jsxs)(n.li,{children:["Production deployments on Vercel exhibited the loop (e.g., ",(0,d.jsx)(n.code,{children:"micelio-rcb48lkwt-*"}),")."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"root-cause",children:"Root Cause"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["The proxy middleware only looked up tenants by ",(0,d.jsx)(n.strong,{children:"slug"}),". New dashboard URLs use ",(0,d.jsx)(n.strong,{children:"numeric tenant IDs"})," (",(0,d.jsx)(n.code,{children:"/en/3/..."}),"), so tenant lookup failed and triggered a redirect to login."]}),"\n",(0,d.jsxs)(n.li,{children:["Role verification inside the middleware used the session-bound Supabase client (subject to RLS). RLS blocked reads on the ",(0,d.jsx)(n.code,{children:"users"})," table, producing false \u201cnot authorized\u201d results and another redirect to login."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"fix",children:"Fix"}),"\n",(0,d.jsxs)(n.ol,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Tenant lookup by ID or slug"}),": Detect numeric second segment and query ",(0,d.jsx)(n.code,{children:"tenants.id"}),"; otherwise use ",(0,d.jsx)(n.code,{children:"tenants.slug"}),". Cache keyed by the incoming identifier. (commit ",(0,d.jsx)(n.code,{children:"ecacac2"}),")."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Locale-aware redirects"}),": Redirect unauthenticated users to ",(0,d.jsx)(n.code,{children:"/${locale}/login"})," to avoid i18n bounce loops. (commit ",(0,d.jsx)(n.code,{children:"ecacac2"}),")."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Role check with service role"}),": Validate ",(0,d.jsx)(n.code,{children:"users.role"}),"/",(0,d.jsx)(n.code,{children:"tenant_id"})," via ",(0,d.jsx)(n.code,{children:"createServiceRoleClient()"})," in the proxy to bypass RLS and accept ",(0,d.jsx)(n.code,{children:"platform_admin"}),", ",(0,d.jsx)(n.code,{children:"tenant_admin"}),", ",(0,d.jsx)(n.code,{children:"staff"}),", or the tenant owner. (commit ",(0,d.jsx)(n.code,{children:"ca9acc6"}),")."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["Vercel deploy ",(0,d.jsx)(n.code,{children:"micelio-hkg3tni24-*"})," (Dec 5, 2025): Playwright MCP login as ",(0,d.jsx)(n.code,{children:"tenant@miicel.io / Tenant123!"})," redirected to ",(0,d.jsx)(n.code,{children:"/en/3/dashboard"})," and loaded successfully with stats. No redirect loop observed."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"lessons-learned",children:"Lessons Learned"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"When URL structures change (slug \u2192 ID), update all auth/middleware layers, not just page components."}),"\n",(0,d.jsx)(n.li,{children:"Middleware auth checks should avoid RLS ambiguity\u2014use service role for authorization decisions when appropriate."}),"\n",(0,d.jsx)(n.li,{children:"Always include locale in middleware redirects when using next-intl to prevent redirect cascades."}),"\n",(0,d.jsxs)(n.li,{children:["Consider future hardening: canonicalize dashboard URLs to slugs only, and redirect numeric-ID routes to the slug path (",(0,d.jsx)(n.code,{children:"/[locale]/[slug]/..."}),") to reduce ambiguity and exposure of tenant IDs. Would require updating link generators, middleware, and E2E fixtures."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"timeline-utc",children:"Timeline (UTC)"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"2025-12-04: Redirect loop reported on dashboard after login."}),"\n",(0,d.jsx)(n.li,{children:"2025-12-05: Fixed tenant lookup (ID/slug) and locale-aware redirects; still blocked by RLS in middleware."}),"\n",(0,d.jsx)(n.li,{children:"2025-12-05: Switched role check to service role; verified on production deploy."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>t});var r=i(6540);const d={},o=r.createContext(d);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);